name: Miatoll ROM Porter (Universal)

on:
  workflow_dispatch:
    inputs:
      source_rom_url:
        description: 'URL прошивки-донора (Source ROM - MIUI/HyperOS/Pixel)'
        required: true
      base_rom_url:
        description: 'URL базовой прошивки (Miatoll Base ROM)'
        required: true
      rom_name:
        description: 'Имя сборки'
        required: true
        default: 'Miatoll_Port'

jobs:
  port_rom:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: rokibhasansagar/slimhub_actions@main

      - name: Install Tools & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip aria2 zip unzip tar brotli liblz4-tool \
          android-sdk-libsparse-utils p7zip-full e2fsprogs erofs-utils device-tree-compiler
          pip3 install protobuf==3.20.*
          # payload_dumper через pip удален, так как port.sh скачивает Go-версию

      - name: Prepare Scripts
        run: |
          mkdir -p scripts
          # Создаем файл скрипта прямо здесь или берем из репозитория
          # В данном случае мы полагаем, что port.sh уже лежит в папке scripts/
          chmod +x scripts/port.sh

      - name: Run Porting Script
        run: |
          sudo bash scripts/port.sh "${{ github.event.inputs.source_rom_url }}" "${{ github.event.inputs.base_rom_url }}" "${{ github.event.inputs.rom_name }}"

      - name: Upload Images
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ github.event.inputs.rom_name }}_Images
          path: out/*.img
          compression-level: 0 # Без сжатия для скорости, так как файлы большие
