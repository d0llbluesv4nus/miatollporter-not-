name: Miatoll ROM Porter

on:
  workflow_dispatch:
    inputs:
      SOURCE_URL:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ Source ROM (–æ—Ç–∫—É–¥–∞ –±–µ—Ä–µ–º —Å–∏—Å—Ç–µ–º—É)'
        required: true
      BASE_URL:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ Base ROM (Miatoll)'
        required: true
      ROM_NAME:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)'
        required: true
        default: 'Miatoll_Port'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (Cleanup)
        # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–æ—Ñ—Ç, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å ~20GB –¥–ª—è —Å–±–æ—Ä–∫–∏
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker image prune --all --force

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip zip unzip curl git aria2 android-sdk-libsparse-utils

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
        run: |
          mkdir -p scripts
          chmod +x scripts/port.sh

      - name: –ó–∞–ø—É—Å–∫ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ sudo
          sudo bash scripts/port.sh "${{ inputs.SOURCE_URL }}" "${{ inputs.BASE_URL }}" "${{ inputs.ROM_NAME }}"

      - name: –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –ø—Ä–æ—à–∏–≤–∫–∏
        run: |
          cd out
          echo "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ ${{ inputs.ROM_NAME }}.zip..."
          zip -r "../${{ inputs.ROM_NAME }}.zip" ./*
          ls -lh "../${{ inputs.ROM_NAME }}.zip"

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –≤ GitHub Releases (–ë—ã—Å—Ç—Ä–æ üöÄ)
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ inputs.ROM_NAME }}.zip"
          tag: "v${{ github.run_number }}_${{ inputs.ROM_NAME }}"
          name: "Build ${{ github.run_number }}: ${{ inputs.ROM_NAME }}"
          body: |
            ‚úÖ –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
            
            **Source:** ${{ inputs.SOURCE_URL }}
            **Base:** ${{ inputs.BASE_URL }}
            
            –°–∫–∞—á–∞–π—Ç–µ ZIP —Ñ–∞–π–ª –Ω–∏–∂–µ üëá
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          makeLatest: true

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Transfer.sh (–ó–∞–ø–∞—Å–Ω–∞—è —Å—Å—ã–ª–∫–∞)
        run: |
          echo "=========================================="
          echo "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Transfer.sh..."
          curl --upload-file "${{ inputs.ROM_NAME }}.zip" "https://transfer.sh/${{ inputs.ROM_NAME }}.zip"
          echo ""
          echo "=========================================="
